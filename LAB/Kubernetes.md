# Лабораторная работа: Введение в Kubernetes (Minikube)

## 1. Цель работы
Познакомиться с основами оркестрации контейнеров с помощью Kubernetes. Развернуть локальный однопользовательский кластер с помощью Minikube, установить клиент `kubectl`, создать тестовое развертывание (Deployment) с веб-сервером Nginx и выполнить масштабирование приложения до 10 работающих экземпляров (подов).

## 2. Теоретическая часть
**Kubernetes** (K8s) — это портативная, расширяемая платформа с открытым исходным кодом для управления контейнеризированными рабочими нагрузками и сервисами. Она автоматизирует развертывание, масштабирование и управление приложениями .

**Minikube** — это инструмент, позволяющий запустить однопользовательский кластер Kubernetes на локальной машине (например, на виртуальной или физической). Он идеально подходит для знакомства с K8s, разработки и тестирования.

**Deployment** — это объект Kubernetes, который управляет развертыванием приложения. Вы описываете *желаемое состояние* (например, образ контейнера и количество копий), а Kubernetes следит за тем, чтобы фактическое состояние соответствовало описанному .

**Pod** — это мельчайшая единица в Kubernetes, которую можно создать и развернуть. Она представляет собой один или несколько контейнеров (в данной работе — один с Nginx), использующих общие сетевые ресурсы и хранилище.

**kubectl** — это основная клиентская утилита командной строки для взаимодействия с кластером Kubernetes .

## 3. Подготовка к работе (домашнее задание)
Перед выполнением лабораторной работы студент должен:
1.  Изучить понятия: контейнеризация, Docker, оркестрация, Kubernetes, Pod, Deployment, ReplicaSet.
2.  Убедиться, что на хост-машине включена виртуализация (Intel VT-x или AMD-V).
3.  Ознакомиться с официальной документацией Minikube и `kubectl`.

## 3. Оборудование и программное обеспечение
1.  Виртуальная машина с установленной ОС **Debian 13** (или свежая версия Debian, например, Debian 13 "Trixie") с выходом в интернет.
2.  Минимальные требования: 2 ядра CPU, 4 ГБ ОЗУ, 20 ГБ свободного места на диске.
3.  Терминал для ввода команд.
4.  Права `sudo` у пользователя.

## 4. Порядок выполнения работы

### Часть 1: Подготовка системы и установка необходимых пакетов

Перед началом работы необходимо обновить список пакетов и установить инструменты для работы с HTTPS-репозиториями.

**Контрольный вопрос 1:** Для чего нужны пакеты `apt-transport-https`, `ca-certificates` и `curl` при установке ПО из внешних репозиториев?

#### Ход работы

1.  Обновите индекс пакетов и установите утилиты:
    ```bash
    sudo apt update
    sudo apt install -y apt-transport-https ca-certificates curl
    ```

### Часть 2: Установка клиента kubectl

Kubectl — это "пульт управления" Kubernetes. Существует несколько способов установки, но мы воспользуемся официальным репозиторием Kubernetes .

**Контрольный вопрос 2:** Что такое kubeconfig-файл и где он обычно хранится?

#### Ход работы

1.  Скачайте и добавьте публичный ключ репозитория Kubernetes.
    *Примечание для Debian 13:* Убедитесь, что директория `/etc/apt/keyrings` существует.
    ```bash
    sudo mkdir -p -m 755 /etc/apt/keyrings
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.33/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    sudo chmod 644 /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    ```

2.  Добавьте репозиторий Kubernetes в список источников APT.
    ```bash
    echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
    sudo chmod 644 /etc/apt/sources.list.d/kubernetes.list
    ```

3.  Обновите индекс пакетов и установите `kubectl`.
    ```bash
    sudo apt update
    sudo apt install -y kubectl
    ```

4.  Проверьте версию установленного клиента:
    ```bash
    kubectl version --client
    ```
    Вы должны увидеть вывод с информацией о версии клиента.

### Часть 3: Установка и запуск Minikube

Minikube предоставляет сам кластер. Мы установим его с помощью бинарного файла.

**Контрольный вопрос 3:** Чем Minikube отличается от "настоящего" production-кластера Kubernetes (например, в облаке)?

#### Ход работы

1.  Скачайте последнюю версию Minikube для Linux (архитектура amd64) с помощью `curl` .
    ```bash
    curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
    ```

2.  Установите скачанный бинарный файл в систему и сделайте его исполняемым.
    ```bash
    sudo install minikube-linux-amd64 /usr/local/bin/minikube
    ```

3.  Запустите Minikube. Процесс может занять несколько минут, так как будет скачан образ виртуальной машины и компоненты Kubernetes.
    ```bash
    minikube start --driver=docker
    ```
    *Примечание:* Если Docker не установлен, Minikube предложит установить его или можно использовать другой драйвер (например, `--driver=virtualbox` или `--driver=kvm2`). В Debian 13 проще всего доустановить Docker: `sudo apt install -y docker.io` и добавить пользователя в группу `docker`: `sudo usermod -aG docker $USER && newgrp docker`.

4.  Проверьте статус кластера:
    ```bash
    minikube status
    ```
    Вы должны увидеть нечто похожее:
    ```
    host: Running
    kubelet: Running
    apiserver: Running
    kubeconfig: Configured
    ```

5.  Проверьте, что `kubectl` "видит" ваш новый кластер:
    ```bash
    kubectl cluster-info
    kubectl get nodes
    ```

### Часть 4: Создание Deployment с Nginx

Теперь, когда кластер работает, мы развернем в нем наше первое приложение .

**Контрольный вопрос 4:** Что произойдет, если один из подов (Pods) с Nginx будет удален вручную? Восстановится ли он автоматически?

#### Ход работы

1.  Создайте файл манифеста Deployment с именем `nginx-deployment.yaml`. Используйте любой текстовый редактор (nano, vim).
    ```bash
    nano nginx-deployment.yaml
    ```

2.  Вставьте в файл следующее содержимое. Этот манифест описывает развертывание с двумя репликами (копиями) контейнера Nginx.
    ```yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: nginx-deployment
      labels:
        app: nginx
    spec:
      replicas: 2  # Начинаем с 2 реплик
      selector:
        matchLabels:
          app: nginx
      template:
        metadata:
          labels:
            app: nginx
        spec:
          containers:
          - name: nginx
            image: nginx:latest
            ports:
            - containerPort: 80
    ```

3.  Примените манифест для создания Deployment в кластере:
    ```bash
    kubectl apply -f nginx-deployment.yaml
    ```

4.  Проверьте статус созданных ресурсов:
    ```bash
    # Посмотреть созданный Deployment
    kubectl get deployments

    # Посмотреть созданные поды (реплики)
    kubectl get pods

    # Посмотреть подробную информацию о Deployment
    kubectl describe deployment nginx-deployment
    ```

### Часть 5: Масштабирование приложения до 10 реплик

Главная сила оркестрации — легкое масштабирование. Увеличим количество работающих экземпляров нашего приложения .

**Контрольный вопрос 5:** Что такое ReplicaSet и как он связан с Deployment?

#### Ход работы

1.  Выполните команду масштабирования, указав желаемое количество реплик (10):
    ```bash
    kubectl scale deployment nginx-deployment --replicas=10
    ```

2.  Немедленно проверьте статус Deployment. Вы увидите, что желаемое количество реплик (`DESIRED`) стало 10.
    ```bash
    kubectl get deployments
    ```

3.  Наблюдайте за процессом создания новых подов. Подождите 1-2 минуты, пока все они не перейдут в статус `Running`.
    ```bash
    kubectl get pods -w   # Флаг -w (watch) позволяет следить за изменениями в реальном времени
    ```
    Нажмите `Ctrl+C` для выхода из режима слежения.

4.  Выведите окончательный список всех подов, чтобы убедиться, что их 10.
    ```bash
    kubectl get pods -o wide   # Флаг -o wide покажет также IP-адреса подов и ноды, на которых они запущены
    ```

5.  **Дополнительное задание (по желанию):** Попробуйте открыть страницу приветствия Nginx через проброс портов.
    ```bash
    kubectl port-forward deployment/nginx-deployment 8080:80
    ```
    Откройте браузер на вашей виртуальной машине или с хоста (если настроена сеть) и перейдите по адресу `http://127.0.0.1:8080`. Вы должны увидеть страницу "Welcome to nginx!".

### Часть 6: Очистка ресурсов

После выполнения работы необходимо удалить созданные ресурсы, чтобы освободить ресурсы виртуальной машины.

#### Ход работы

1.  Удалите созданный Deployment:
    ```bash
    kubectl delete deployment nginx-deployment
    ```

2.  Убедитесь, что поды удалены:
    ```bash
    kubectl get pods
    ```

3.  Остановите и удалите кластер Minikube:
    ```bash
    minikube stop
    minikube delete
    ```

## 5. Содержание отчета

Отчет должен быть оформлен в электронном виде и содержать:

1.  **Титульный лист** с названием работы, ФИО студента, группой.
2.  **Цель работы.**
3.  **Ход работы** с описанием каждого шага и **обязательными скриншотами**, подтверждающими выполнение ключевых этапов:
    *   Результат команды `kubectl version --client`.
    *   Результат команды `minikube status`.
    *   Содержимое файла `nginx-deployment.yaml`.
    *   Результат команды `kubectl get pods` после создания Deployment (должно быть 2 пода).
    *   Результат команды `kubectl get pods` после масштабирования до 10 реплик.
    *   *(Опционально)* Скриншот страницы Nginx, открытой через `port-forward`.
4.  **Ответы на контрольные вопросы** (развернутые, не односложные).
5.  **Вывод** по работе (что нового узнали, с какими трудностями столкнулись, достигнута ли цель).

## 6. Контрольные вопросы для защиты
1.  Каково назначение компонента `kubelet` в кластере Kubernetes?
2.  В чем разница между командами `kubectl apply` и `kubectl create`?
3.  Что произойдет с трафиком, если один из 10 подов Nginx перестанет отвечать, и мы попробуем обратиться к нему через сервис (Service)?
4.  Для чего нужно поле `selector` в манифесте Deployment?
5.  Какими способами, кроме `kubectl scale`, можно изменить количество реплик в Deployment?
